machine:
  environment:
    RAILS_ENV: test
    QMAKE: /opt/qt5/bin/qmake
  node:
    version: 5
checkout:
  post:
    - cp .sample.env .env
    - cp client/.sample.env client/.env
dependencies:
  pre:
    - sudo apt-get update -y; true
    - sudo apt-get install apt -y
    - sudo apt-get -y install qt5-default qt5-qmake qtbase5-dev libqt5webkit5-dev
    - echo "/opt/qt5/bin/qt5-env.sh" >> ~/.circlerc
  override:
    - bundle config --local path .bundle
    - bundle config --local without development
    - bundle check || bundle install --jobs 4 --retry 3
    - cd client; npm install --no-optional
    - cd client; node_modules/.bin/bower --version || npm install bower
    - cd client; node_modules/.bin/bower install
  cache_directories:
    - .bundle
    - client/node_modules
    - client/bower_components
database:
  override:
    - bin/rake dev:prime
test:
  override:
    - bin/rake
  post:
    - cp tmp/rspec.xml $CIRCLE_TEST_REPORTS
deployment:
  staging:
    branch: master
    commands:
      - git remote add staging git@heroku.com:schoolbot-staging.git
      - bin/deploy staging
